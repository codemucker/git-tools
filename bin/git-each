#!/usr/bin/env tm-env-bash
#
# Run a git command on all child repos
#

_include .git.sh @tm/lib.args.sh

declare -A args
# Using --opts-* to capture the command and its arguments after '--'
_parse_args \
    --file "${BASH_SOURCE[0]}" \
    --opt-command "|remainder|multi|short=c|long=command|value=COMMAND|desc=The command (with args) to run.|example='git status --short', 'git add .'" \
    --opt-parallel "|short=p|flag|desc=Run in parallel. Will wait for all processes to complete" \
    --opt-quiet "|short=q|flag|desc=Don't output the dir name" \
    --opt-dir "|short=d|desc=The directory to start from|default=." \
    --result args \
    -- "$@"

[[ "${args[quiet]}" == "1" ]] && level=debug || level=info
[[ "${args[parallel]}" == "1" ]] && parallel=1 || parallel=0

root_dir="${args[dir]}"

declare -A GIT_COMMANDS=(\
    [add]="git add" \
    [amend]='git commit --amend' \
    [ammend]='git commit --amend' \
    [checkout]="git checkout" \
    [commit]="git commit" \
    [config]="git config" \
    [diff]="git diff" \
    [log]="git log" \
    [push]="git push" \
    [restore]="git restore" \
    [save]="git-save" \
    [show]="git show" \
    [status]="git status" \
)
DEFAULT_CMD="pwd"
first_command="$(echo "${args['command']:-$DEFAULT_CMD}" | cut -d ' ' -f1)"
first_command_args="$(echo "${args['command']}" | cut -d ' ' -f2-)" 

git_command="${GIT_COMMANDS["$first_command"]:-}"

[[ -n "$git_command" ]] && command="$git_command $first_command_args" || command="${args['command']:-$DEFAULT_CMD}"

# common ignore dirs
IGNORE_DIRS=(
    "node_modules"
    "build"
    "dist"
    "__pycache__"
    "venv"
    "env"
    "coverage"
)

# Build the -o -name "dir" parts for the IGNORE_DIRS
exclude_conditions=""
for dir in "${IGNORE_DIRS[@]}"; do
    exclude_conditions+=" -o -name \"$dir\" "
done

declare project_dir
find "${root_dir}" -type d \
    \( -name ".*" ${exclude_conditions} \) -prune \
    -o -name ".git" -print0 | while IFS= read -r -d $'\0' git_dir; do
    project_dir="$(dirname "$git_dir")"
    _pushd "$project_dir"
        _log $level "in $PWD =>"
        if git rev-parse --is-inside-work-tree &>/dev/null; then
            if [[ $parallel == 1 ]]; then
                ( eval "$command" ) &
            else
                ( eval "$command" || true )
            fi
        fi    
    _popd
done


if [[ $parallel == 1 ]]; then # wait for all background jobs to finish
    _info "waiting for parallel jobs to complete..."
    wait
    _info "..complete"
fi